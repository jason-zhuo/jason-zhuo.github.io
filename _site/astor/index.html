
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
  <head>
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1">
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="" />
    <title>“Tor and autonomous system”</title>
    <meta name="name" content="Jaosonzhuo's blog" />
    <meta name="description" content="“”" />
    <meta name="keywords" content= "Tor" />
    <meta name="ujianVerification" content="109d1a9f6085ee6606156bc3aa65a955" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link href="/feed/" rel="alternate" title="" type="application/atom+xml" />
    <link rel="stylesheet" href="/media/css/mystyle.css" />
    <script src="http://libs.baidu.com/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
    

  </head>
  <body>
    <div id="container">

    <aside id="sidebar" class="alignleft">
        <div class="navigationBar">
            <a href="/">Jasonzhuo's Blog</a>
        </div>

        <nav class="widget" id="menu">
            <ul>
              <li class="cell"><a class="next" href="/">Home</a></li>
              <li class="cell"><a class="next" href="/categories/">Archives</a></li>
              <li class="cell"><a class="next" href="/search/">Search</a></li>
              <li class="cell"><a class="next" href="/feed.xml">RSS</a></li>
            </ul>
        </nav>

        <div class="widget weibo">
            <iframe width="100%" height="120" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=120&fansRow=2&ptype=1&speed=0&skin=7&isTitle=1&noborder=0&isWeibo=0&isFans=0&uid=2385225700&verifier=0cad5c7b&dpc=1"></iframe>  
        </div>


        <div class="widget gostats">
            <h3 class="title"><B>Vistor Statistics</B></h3>

            <div class="entry">
<!-- GoStats Simple HTML Based Code -->
<a target="_blank" title="访客计数器" href="http://gostats.cn"><img alt="访客计数器" 
src="http://c5.gostats.cn/bin/count/a_1066403/t_4/i_102/z_1/show_visitors/counter.png" 
style="border-width:0" /></a>
<!-- End GoStats Simple HTML Based Code -->
            </div>
        </div>

        <!-- <table class="widget ad" border="">
            <tbody>
                <tr>
                    <td class="icon">
                        <a href="/evermark"><img src="http://esoftmobile.com//evermark/icon.png"></a>                  
                    </td>
                    <td class="title">
                        <a href="/evermark">Evermark</a>
                    </td>
                    <td class="button">
                        <a target="_blank" href="https://itunes.apple.com/cn/app/evermark/id728159144?mt=8">下载</a>
                    </td>
                </tr>
            </tbody>
        </table>  -->

        <div class="widget tagcloud">
            <h3 class="title"><B>Useful Tags</B></h3>
            <div class="entry">
                <div id='tag_cloud'>
                    
                    <a href="/tags/#Hello world" title="Hello world" rel="1">Hello world</a>
                    
                    <a href="/tags/#Linux" title="Linux" rel="1">Linux</a>
                    
                    <a href="/tags/#Bash" title="Bash" rel="1">Bash</a>
                    
                    <a href="/tags/#Matlab" title="Matlab" rel="1">Matlab</a>
                    
                    <a href="/tags/#Bigdata" title="Bigdata" rel="1">Bigdata</a>
                    
                    <a href="/tags/#Math equation" title="Math equation" rel="1">Math equation</a>
                    
                    <a href="/tags/#Big data" title="Big data" rel="1">Big data</a>
                    
                    <a href="/tags/#SRM" title="SRM" rel="1">SRM</a>
                    
                    <a href="/tags/#Machine learning" title="Machine learning" rel="2">Machine learning</a>
                    
                    <a href="/tags/#Botnet" title="Botnet" rel="2">Botnet</a>
                    
                    <a href="/tags/#fast flux" title="fast flux" rel="1">fast flux</a>
                    
                    <a href="/tags/#Proxy，Shadowsocks" title="Proxy，Shadowsocks" rel="1">Proxy，Shadowsocks</a>
                    
                    <a href="/tags/#encrypted flow" title="encrypted flow" rel="2">encrypted flow</a>
                    
                    <a href="/tags/#SDN" title="SDN" rel="1">SDN</a>
                    
                    <a href="/tags/#Random forest" title="Random forest" rel="1">Random forest</a>
                    
                    <a href="/tags/#clustering" title="clustering" rel="1">clustering</a>
                    
                    <a href="/tags/#Crawler" title="Crawler" rel="1">Crawler</a>
                    
                    <a href="/tags/#Java" title="Java" rel="1">Java</a>
                    
                    <a href="/tags/#Network" title="Network" rel="1">Network</a>
                    
                    <a href="/tags/#Tor" title="Tor" rel="2">Tor</a>
                    
                    <a href="/tags/#Go" title="Go" rel="1">Go</a>
                    
                    <a href="/tags/#Docker" title="Docker" rel="1">Docker</a>
                    
                    <a href="/tags/#Deep Learning" title="Deep Learning" rel="1">Deep Learning</a>
                    
                    <a href="/tags/#Malware" title="Malware" rel="1">Malware</a>
                    
                    <a href="/tags/#IP traceback" title="IP traceback" rel="1">IP traceback</a>
                    
                    <a href="/tags/#flow hashing" title="flow hashing" rel="1">flow hashing</a>
                    
                    <a href="/tags/#Trouble Shooting" title="Trouble Shooting" rel="1">Trouble Shooting</a>
                    
                </div>
            </div>

            <script src="/media/js/jquery.tagcloud.js" type="text/javascript" charset="utf-8"></script> 
            <script language="javascript">
            $.fn.tagcloud.defaults = {
                size: {start: 1, end: 2, unit: 'em'}
            };

            $(function () {
                $('#tag_cloud a').tagcloud();
            });
            </script>
        </div>

        <footer id="footer" class="inner">
            <div class="copyright">
            <a href="http://jekyllrb.com" target="_blank">Jekyll</a> @ <a href="https://github.com/jason-zhuo" target="_blank" title="项目主页">GitHub</a>
             | <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/cn/" target="_blank" title="许可协议">©</a> 2017 <a href="/about/"></a>
             </div>
             <!-- <div class="copyright">
                <script type="text/javascript">var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fcbf651a0c9c199e73857441cc83b3884' type='text/javascript'%3E%3C/script%3E"));
                </script>
             </div> -->
        </footer>

    </aside>

    <div id="hidden-navigationBar" class="navigationBar">
      <a href="/">Jasonzhuo's Blog</a>
    </div>

    <div id="main-col" class="alignright">
        <div id="wrapper">   
    
         <article class="post">
<div class="post-content">




<header>
    <h1 class="title">“Tor and autonomous system”</h1>
    <section class="meta">
<span class="time">
  <time datetime="2017-05-03">2017-05-03</time>
</span>

 | 
<span class="categories">
  分类
  
  <a href="/categories/#Infosec" title="Infosec">Infosec</a>&nbsp;
  
</span>


 | 
<span class="tags">
  标签
  
  <a href="/tags/#Tor" title="Tor">Tor</a>&nbsp;
  
</span>


</section>    
</header>

<div class="entry">

  <p><img src="/assets/images/TorAs.jpg" alt="image" /></p>

<p>Tor 在自治域（As-level）上面的一些论文阅读和相关知识介绍</p>

<!-- more -->


<h2>引言</h2>

<p>近年来越来越多的顶会和文章在做Tor匿名网络相关的攻防工作，其中比较出名的就是Raptor[1]和 Counter Raptor[2]
这两篇文章所讨论的对象是(AS-level)自治域级别上的攻防。自治域上的Tor攻防最早是由[3]在2004年提出的。此后在AS-level上进行攻防研究的论文就很多，本篇就不一一列举了，读者可以翻看论文参考文献和相关工作。这些攻防内容的基本原理不变：</p>

<ol>
<li>AS-level上的攻击的基本原理是：无论采用主动或者被动手段，使得如果Tor选择的链路，用户到入口段和出口到目的地段都在同一个AS内，那么该AS就可以利用流量分析和简单的统计关联技术将用户和目的地关联起来。</li>
<li>As-level上的防御基本原理是：既然用户选路在同一个AS内部存在风险，那么就进行As-aware的选路吧，使得用户选择的路径尽量通过不同的AS。</li>
</ol>


<h3>BGP协议的基本概念</h3>

<p>BGP协议是运行在AS之间的路由协议，大多数互联网服务提供商（ISP）必须使用BGP来与其他ISP创建路由连接。BGP属于矢量路由协议，采用TCP协议，端口号为179。BGP路由器会周期地发送19字节的保持存活keep-alive消息来维护连接（默认周期为60秒）。在路由协议中，只有BGP使用TCP作为传输层协议。</p>

<h3>Raptor</h3>

<p>Raptor[1]和之前的AS-level的文章不同，之前AS-level的文章都是假设网络上的的路由都是对称的。这篇文章从<strong>asymmetric nature of Internet routing</strong>，<strong>BGP Churn</strong>, <strong>BGP Hijack</strong>, <strong>BGP Interception</strong>四种新的方法讨论对Tor的攻击。Raptor攻击的基本思想是，首先利用之前论文的一些方法锁定用户的入口位置（AS号），然后再利用BGP interception或者hijack来进行流关联分析（对比用户到入口和出口到目标网站之间的流量，主要利用TCP ack和sequence number来进行关联对比），最终达到用户关联溯源目的。</p>

<h4>非对称性路由</h4>

<p>互联网路由的非对称性在该文章中表现在，1）Tor出口节点到网站的所经过的路由可能和网站到出口节点所经过的路由不同。2）用户到入口节点所经过的路由和从入口节点返回Tor用户所经过的路由不同。</p>

<h4>Natural Churn</h4>

<p>引起Natural Churn的原因是网络底层链路变化，例如，链路失效，增加减少新的路由设备，ISP直接的新合作等等。这些变化可以给恶意AS提供溯源优势，因为可能链路变化后AS之间的传输路径就恰好通过了恶意AS。</p>

<p>作者在文章中是利用某一时期的BGP update数据，以及同一时期的Tor链路数据，进行仿真计算出来链路的变化。</p>

<h4>BGP Hijack 和BGP Interception</h4>

<p>BGP Hijack可以参考[4]。这里简单总结一下，BGP劫持的基本原理是，BGP协议会选择两种路径作为AS通信的下一跳，第一种是路径最短的，如果路径相同那么就选择一条前缀更具体的链路。 BGP 劫持后，Tor用户会感受到断路，因为Tor用户最后去向的入口节点的数据包会被丢弃。但是BGP劫持攻击已经可以缩小和暴露用户的IP地址集合，从而破坏了匿名性。</p>

<p>BGP Interception本质上类似于中间人攻击，让攻击者能够成为Tor用户到Tor入口节点之间的AS，换句话说就是BGP interception会将traffic重新发送给入口节点，而不会将traffic丢弃，这样攻击方式更隐蔽，因为Tor用户不会体会到断路现象。 BGP Interception 和 BGP攻击原理类似，不同就是恶意AS声明的也是前缀同样具体的自治域。BGP Hijack, BGP Interception还有一点不同就是，BGP Hijack发出的错误路由信息会影响整个网络，从而导致恶意AS不能将traffic重新传送到消息原来发出的地方。值得注意的是，即便声明和自治域相同的前缀也不一定能够部分或者全部截取流量到恶意自治域，这里面考虑的因素包括IGP metrics以及运营商自定义的优先处理规则等，可以参考下图和参考文献[6]。</p>

<p><img src="/assets/images/bgpfail.png" alt="image" />
<img src="/assets/images/fraction.png" alt="image" /></p>

<p>在[5]中作者比较了BGP Hijack 和BGP Interception成功概率的大小。</p>

<p><img src="/assets/images/bgphi.png" alt="image" /></p>

<p>上图表现了由于ASes之间的相互关系（Costomer-to-provider, peer, Provider-to-comstomer）在不同层级AS上BGP Hijack 和BGP Interception成功概率。如图所示，最高T1级AS成功概率最大，因为这一级的AS只有peer, Provider-to-comstomer之间的通信关系。文章重要结论之一是：<strong>Invalid routes advertised by ASes lower down in the hierarchy wouldn’t have as significant an impact.</strong></p>

<h4>Counter Raptor</h4>

<p>Counter Raptor的基本思想是，文章提出一个算法来对AS抗攻击属性进行量化，然后利用这个指标来辅佐原来的Tor选路算法进行选路，从而降低链路被BGP hijack或intercetption的概率。具体如何计算的，参考[2]。</p>

<h4>Interception检测</h4>

<p>检测方法包括检测routing advertisements的错误，判断hop count changes等都不能实时检测Interception。还有其他大多数的方案都是基于前缀劫持的以下两个重要特征来研究相关检测技术[7]：</p>

<ol>
<li>MOAS 冲突:即一个 prefix 匹配多个 origin AS 的行为。这是前缀劫持之于路由控制平面最重要的一个特征</li>
<li>IP 地址冲突: 在数据平面层次上,前缀劫持直接导致了一个目的 IP 地址(被劫持的前缀)存在多个不同
的路由目的地的问题.也就是说:假设 16.1.0.0/16 为 AS 1 所有,但被 AS 2 劫持,则目的地址为 16.1.0.0/
16 的数据包可能分别从 AS 1 和 AS 2 返回.或者,源地址为 16.1.0.0/16 的数据包可能有去无回(返回
数据包被路由到 AS 2).</li>
</ol>


<h5>内部网关协议OSPF和RIP</h5>

<p>OSPF协议同时使用单播（Unicast）和组播（Multicast）来发送Hello包和链路状态更新（Link State Updates），使用的组播地址为224.0.0.5和224.0.0.6。与RIP和BGP不同的是，OSPF协议不使用TCP或者UDP协议而是承载在IP协议之上，IP协议号为89，工作在OSI模型的传输层。OSPF协议将不同路由划分为不同区域，相同区域内的所有路由器都维护一份相同的链路状态数据库（LSDB），如果一台路由器属于多个区域，那么它将为每一个区域维护一份LSDB。</p>

<p>RIP是距离向量算法，在实际使用中已经较少适用。RIP使用UDP端口号为520。</p>

<p>这里总结内部网关协议的目的，是为了探索内部选路的是否可以对Tor造成一定影响，不过目前来看好像影响不大，除非用户选路都在同一个AS中的情况或许还有可能进行追踪。</p>

<hr />

<h3>参考（Refs）</h3>

<p>[1] Sun Y, Edmundson A, Vanbever L, et al. RAPTOR: Routing Attacks on Privacy in Tor[C]//USENIX Security. 2015: 271-286.</p>

<p>[2] Sun Y, Edmundson A, Feamster N, et al. Counter-RAPTOR: Safeguarding Tor Against Active Routing Attacks[J]. arXiv preprint arXiv:1704.00843, 2017 S&amp;P accepted.</p>

<p>[3] Feamster N, Dingledine R. Location diversity in anonymity networks[C]//Proceedings of the 2004 ACM workshop on Privacy in the electronic society. ACM, 2004: 66-76.</p>

<p>[4] http://www.freebuf.com/articles/network/75305.html</p>

<p>[5] Ballani H, Francis P, Zhang X. A study of prefix hijacking and interception in the Internet[C]//ACM SIGCOMM Computer Communication Review. ACM, 2007, 37(4): 265-276.</p>

<p>[6] http://www.h3c.com.cn/MiniSite/Technology_Circle/Net_Reptile/The_Tthree/Home/Catalog/201010/696835_97665_0.htm</p>

<p>[7]黎松, 诸葛建伟, 李星. BGP 安全研究[J]. 软件学报, 2013, 24(1).</p>


  <p style="margin:20px 0; color:#9f9f9f; font-size:12px;">
  <span>Posted by <a style="color:#9f9f9f;" href="http://http://weibo.com/zhongliuzhuo316"><strong>灵犀一点00</strong></a> - 2017-05-03</span><br>
  <span style="line-height:13px;">如需转载，请注明： 本文来自 <a style="color:#9f9f9f;" href="http://jason-zhuo.github.io/"><strong>Jasonzhuo's Blog</strong></a></span>
  </p>
</div>

<footer>

<!-- JiaThis Button BEGIN -->
<div class="jiathis_style_32x32">
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_renren"></a>
  <a href="http://www.jiathis.com/share?uid=1976264" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config = {data_track_clickback:'true'};
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1976264" charset="utf-8"></script>
<!-- JiaThis Button END -->


</footer>
</div>
</article>

<section class="pageselect">
<br/>
<span class="pre-span">  
  <a  href="" >已经是第一篇 </a>
</span>
<span class="next-span">
  <a  href="/macteamviewer/" class="pageNav"  >下一篇&nbsp;-&nbsp;Mac TeamViewer SSH 远程登录恢复 </a>
</span>
<span class="mobile-pre-span">  
  <a  href="" >已经是第一篇 </a>
</span>
<span class="mobile-next-span">
  <a  href="/macteamviewer/" class="pageNav"  >下一篇</a>
</span>
</section>


	
	<div class="ds-thread" />
		
	<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'jasonzhuo'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    <script type="text/javascript">
    var disqus_shortname = 'jasonzhuo';

    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>



  
        
        </div>
    </div>

    </div>
  </body>
</html>
